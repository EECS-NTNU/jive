TESTS=\
	test_metacontainers\
	test_context\
	test_graph\
	test_graphtraverser\
	test_empty_graph\
	test_mutable_traverser\
	test_prune_replace\
	test_rescls_count\
	test_statesplit\
	test_typemismatch\
	test_rangemap\
	test_negotiator\

# 	test_resource\
# 	test_interference\
# 	test_shape\
# 	test_shape_crossings\
# 	test_subgraph_shape\
# 	test_gate_interference\
 	
# 	test_bitstring1\
# 	test_bitstring2\
# 	test_bitstring3\
# 	test_machinedef\
# 	arithmetic_function

# include tests/util/Makefile.sub
include tests/arch/Makefile.sub
include tests/shape/Makefile.sub
include tests/regalloc/Makefile.sub
include tests/types/Makefile.sub
include tests/i386/Makefile.sub
include tests/function/Makefile.sub
include tests/transforms/Makefile.sub
include tests/record/Makefile.sub
include tests/union/Makefile.sub

TESTPROGS=$(patsubst %, tests/%, $(TESTS))

$(TESTPROGS): %: %.o tests/testarch.o libjive.a
# tests/testnodes.o tests/graph-sanity-checks.o libjive.a

$(patsubst %, tests/%.o, $(TESTS)): CPPFLAGS+=-Itests

TESTLOG=true

check: $(TESTPROGS)
	rm -rf check.log
	@FAILED_TESTS="" ; \
	for TEST in $(TESTPROGS); do \
		$(TESTLOG) -n "$$TEST: " ; if $$TEST >>check.log 2>&1 ; then $(TESTLOG) pass ; else $(TESTLOG) FAIL ; FAILED_TESTS="$$FAILED_TESTS $$TEST" ; fi ; \
	done ; \
	if [ "x$$FAILED_TESTS" != x ] ; then echo "Failed tests:$$FAILED_TESTS" ; else echo "All tests passed" ; fi

valgrind-check: $(TESTPROGS)
	rm -rf check.log
	@FAILED_TESTS="" ; \
	for TEST in $(TESTPROGS); do \
		$(TESTLOG) -n "$$TEST: " ; if valgrind --error-exitcode=1 $$TEST >>check.log 2>&1 ; then $(TESTLOG) pass ; else $(TESTLOG) FAIL ; FAILED_TESTS="$$FAILED_TESTS $$TEST" ; fi ; \
	done ; \
	if [ "x$$FAILED_TESTS" != x ] ; then echo "Failed tests:$$FAILED_TESTS" ; else echo "All tests passed" ; fi
